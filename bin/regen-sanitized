#!/usr/bin/env python
PAGE_SIZE = 500


def page_query(q):
    offset = 0
    while True:
        r = False
        for elem in q.limit(PAGE_SIZE).offset(offset):
            r = True
            yield elem
        offset += PAGE_SIZE
        if not r:
            break


def main():
    # Load config before anything
    from inbox.config import load_config
    load_config()

    from inbox.models.session import session_scope
    from inbox.models import Message, Part

    with session_scope() as db_session:
        c = 1
        for msg in page_query(db_session.query(Message).join(Part)):
            print msg.id,
            if not msg.decode_error:
                msg.calculate_sanitized_body()

                c += 1
                if c % PAGE_SIZE == 0:
                    db_session.commit()

        db_session.commit()

if __name__ == '__main__':
    main()
